<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealership Dashboard - Vehicle Processing Center</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-car"></i>
                    <h1>Vehicle Processing Dashboard</h1>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <span class="user-name">
                            <i class="fas fa-user"></i> 
                            <span id="username">Loading...</span>
                        </span>
                        <span class="store-id">
                            <i class="fas fa-store"></i> 
                            Store: <span id="store-id">Loading...</span>
                        </span>
                    </div>
                    <div class="date-filter-container">
                        <div class="date-filter-label">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Date Range:</span>
                        </div>
                        <select id="global-date-filter" class="date-filter-dropdown">
                            <option value="mtd">Month to Date</option>
                            <option value="ytd">Year to Date</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <div class="current-range-display" id="current-range-display">
                            This Month
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" id="sidebar-toggle" style="display: none;">
        <i class="fas fa-chart-line"></i>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard-layout">
            <div class="sidebar" id="book-value-sidebar">
                <div class="sidebar-header">
                    <div class="header-content">
                        <h3 id="sidebar-title">Book Value Changes</h3>
                        <p class="sidebar-subtitle" id="sidebar-breakdown-period">Recent Activity</p>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div class="book-value-cards" id="book-value-cards-container">
                        <!-- Book value cards will be populated here -->
                    </div>
                    <div class="sidebar-empty" id="sidebar-empty" style="display: none;">
                        <div class="empty-icon">ðŸ“Š</div>
                        <p>No value changes detected for this period</p>
                    </div>
                </div>
            </div>
            
            <div class="main-container">
                <div class="container">
                    <!-- Statistics Section -->
            <section class="statistics-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-vehicles">-</div>
                            <div class="stat-label">Total Vehicles</div>
                        </div>
                    </div>
                    

                    
                    <div class="stat-card">
                        <div class="stat-icon info">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="descriptions-updated">-</div>
                            <div class="stat-label">Descriptions Updated</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-features">-</div>
                            <div class="stat-label">Features Marked</div>
                        </div>
                    </div>
                    
                    <div class="stat-card time-saved-card">
                        <div class="stat-icon activity">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="time-saved">0 MINUTES</div>
                            <div class="stat-label">TIME SAVED</div>
                            <!-- <div class="time-saved-details" id="time-saved-details">
                                <small class="text-muted">11 min Ã— <span id="vehicles-processed">0</span> vehicles</small>
                            </div> -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Search and Filter Section -->
            <section class="search-section">
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="Search by stock number..." autocomplete="off">
                        <button class="search-clear" id="search-clear" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-filters">
                        <select id="status-filter">
                            <option value="">All Status</option>
                            <option value="success">Successful</option>
                            <option value="failed">Failed</option>
                        </select>
                        <select id="description-filter">
                            <option value="">All Descriptions</option>
                            <option value="updated">Updated</option>
                            <option value="none">Not Updated</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Vehicles Section -->
            <section class="vehicles-section">
                <div class="section-header">
                    <h2>Vehicle Processing Records</h2>
                    <div class="section-actions">
                        <span class="results-count" id="results-count">Loading...</span>
                    </div>
                </div>

                <!-- Loading State -->
                <div class="loading-state" id="loading-state">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <p>Loading vehicle data...</p>
                </div>

                <!-- Error State -->
                <div class="error-state" id="error-state" style="display: none;">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <p id="error-message">Failed to load vehicle data</p>
                    <button class="btn btn-primary" onclick="loadVehicles()">Try Again</button>
                </div>

                <!-- Vehicles Grid -->
                <div id="vehicles-grid">
                    <!-- Vehicle cards will be dynamically populated -->
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination" style="display: none;">
                    <button class="pagination-btn" id="prev-btn" onclick="changePage(-1)">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <div class="pagination-info">
                        Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                    </div>
                    <button class="pagination-btn" id="next-btn" onclick="changePage(1)">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </section>

                </div>
            </div>
        </div>
    </main>

    <!-- Vehicle Details Modal -->
    <div class="modal" id="vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Vehicle Details</h3>
                <div class="modal-actions">
                    <button class="btn btn-danger btn-sm" id="delete-vehicle-btn" onclick="deleteVehicle()" style="display: none;" title="Delete this completed vehicle record">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Vehicle details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="delete-confirmation-modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="delete-confirmation">
                    <i class="fas fa-exclamation-triangle warning-icon"></i>
                    <p>Are you sure you want to delete this vehicle record?</p>
                    <p id="delete-vehicle-info" class="vehicle-info"></p>
                    <p class="warning-text">This action cannot be undone.</p>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                    <button class="btn btn-danger" id="confirm-delete-btn" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Delete Vehicle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Date Range Modal -->
    <div class="modal" id="date-range-modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Select Custom Date Range</h3>
                <button class="modal-close" onclick="closeDateRangeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="date-range-form">
                    <div class="date-input-group">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date" class="date-input">
                    </div>
                    <div class="date-input-group">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date" class="date-input">
                    </div>
                    <div class="date-range-presets">
                        <h4>Quick Select</h4>
                        <div class="preset-buttons">
                            <button class="btn btn-sm btn-outline" onclick="selectPresetRange('last7days')">Last 7 Days</button>
                            <button class="btn btn-sm btn-outline" onclick="selectPresetRange('last30days')">Last 30 Days</button>
                            <button class="btn btn-sm btn-outline" onclick="selectPresetRange('last90days')">Last 90 Days</button>
                            <button class="btn btn-sm btn-outline" onclick="selectPresetRange('thisyear')">This Year</button>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeDateRangeModal()">Cancel</button>
                    <button class="btn btn-primary" id="apply-date-range-btn" onclick="applyCustomDateRange()">
                        <i class="fas fa-check"></i> Apply Range
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container">
        <!-- Toast notifications will appear here -->
    </div>

    <script src="/static/js/dashboard.js?v=20250903"></script>
    <script>
        function logout() {
            // Remove token from localStorage
            localStorage.removeItem('token');
            
            // Redirect to login page
            window.location.href = '/login';
        }

        // Global delete functions
        let currentVehicleToDelete = null;

        function deleteVehicle() {
            if (dashboard && dashboard.currentVehicle) {
                currentVehicleToDelete = dashboard.currentVehicle;
                showDeleteModal();
            }
        }

        function showDeleteModal() {
            if (currentVehicleToDelete) {
                const deleteModal = document.getElementById('delete-confirmation-modal');
                const vehicleInfo = document.getElementById('delete-vehicle-info');
                
                vehicleInfo.innerHTML = `
                    <strong>Stock Number:</strong> ${currentVehicleToDelete.stock_number}<br>
                    ${currentVehicleToDelete.vehicle_name ? `<strong>Vehicle:</strong> ${currentVehicleToDelete.vehicle_name}` : ''}
                `;
                
                deleteModal.style.display = 'flex';
            }
        }

        function closeDeleteModal() {
            const deleteModal = document.getElementById('delete-confirmation-modal');
            deleteModal.style.display = 'none';
            currentVehicleToDelete = null;
        }

        async function confirmDelete() {
            if (!currentVehicleToDelete) return;

            const confirmBtn = document.getElementById('confirm-delete-btn');
            const originalText = confirmBtn.innerHTML;
            
            try {
                // Show loading state
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                confirmBtn.disabled = true;

                const response = await dashboard.authenticatedFetch(`/api/vehicle/${currentVehicleToDelete.id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    dashboard.showToast(`Vehicle ${currentVehicleToDelete.stock_number} deleted successfully`, 'success');
                    closeDeleteModal();
                    closeModal();
                    // Refresh the vehicle list
                    dashboard.loadVehicles();
                    dashboard.loadStatistics();
                } else {
                    throw new Error(data.message || 'Failed to delete vehicle');
                }
            } catch (error) {
                console.error('Error deleting vehicle:', error);
                dashboard.showToast('Failed to delete vehicle: ' + error.message, 'error');
            } finally {
                // Restore button state
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        // Load user information
        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                const response = await authenticatedFetch('/api/me');
                const userData = await response.json();
                
                if (userData) {
                    document.getElementById('username').textContent = userData.username || 'Unknown';
                    document.getElementById('store-id').textContent = userData.store_id || 'Unknown';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                // Redirect to login if there's an error
                window.location.href = '/login';
            }
        }

        // Global Date Filter Functions
        function closeDateRangeModal() {
            const modal = document.getElementById('date-range-modal');
            modal.style.display = 'none';
            // Reset dropdown to previous value if custom was cancelled
            if (window.globalDateFilter && window.globalDateFilter.currentFilter !== 'custom') {
                document.getElementById('global-date-filter').value = window.globalDateFilter.currentFilter;
            }
        }

        function selectPresetRange(preset) {
            const today = new Date();
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            switch (preset) {
                case 'last7days':
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(today.getDate() - 7);
                    startDateInput.value = sevenDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'last30days':
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'last90days':
                    const ninetyDaysAgo = new Date(today);
                    ninetyDaysAgo.setDate(today.getDate() - 90);
                    startDateInput.value = ninetyDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'thisyear':
                    const startOfYear = new Date(today.getFullYear(), 0, 1);
                    startDateInput.value = startOfYear.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
            }
        }

        function applyCustomDateRange() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be later than end date');
                return;
            }
            
            if (window.globalDateFilter) {
                console.log('Applying custom date range:', startDate, 'to', endDate);
                window.globalDateFilter.customStartDate = startDate;
                window.globalDateFilter.customEndDate = endDate;
                window.globalDateFilter.currentFilter = 'custom';
                window.globalDateFilter.updateRangeDisplay();
                window.globalDateFilter.notifyFilterChange();
                
                // Update the dropdown to show 'custom' is selected
                const dropdown = document.getElementById('global-date-filter');
                if (dropdown) {
                    dropdown.value = 'custom';
                }
                
                console.log('Custom date range applied, filter object:', window.globalDateFilter.getDateRange());
            }
            
            closeDateRangeModal();
        }
        
        // Check if user is authenticated on page load
        window.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // Load user info
            loadUserInfo();
        });
    </script>
</body>
</html>